<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Zuschnitt Reste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    .print-button { position: fixed; top: 10px; right: 10px; font-size: 16px; background: none; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; }
    @media print { .print-button { display: none; } body { margin: 0; background: #fff; } }

    /* Raster: 3 Spalten √ó 2 Reihen */
    .grid { display: grid; grid-template-columns: repeat(3, auto); gap: 10px; justify-content: center; margin-top: 50px; }
    .table {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #fff;
      padding: 6px;
      border: 1px solid #ccc;
      font-size: 12px;
      break-inside: avoid;
      page-break-inside: avoid;
      max-width: 200px;   /* kompakte Breite */
      box-sizing: border-box;
    }
    label { font-weight: bold; font-size: 11px; }
    input { padding: 3px; font-size: 11px; border: 1px solid #bbb; border-radius: 3px; }
    input[readonly] { background: #f2f2f2; }

    .artikel-row { display: flex; align-items: center; gap: 6px; }
    .artikelnummer { width: 100px; }
    .barcode { width: 120px; height: 40px; }

    /* Alle anderen Felder k√ºrzer */
    .table input:not(.artikelnummer) {
      width: 50%;
    }

    /* Rabattpreis bleibt gro√ü, aber auch halb so breit */
    .preisRabatt {
      width: 50%;
      font-size: 20px;
      font-weight: bold;
      color: red;
      background: #fff0f0;
      border: 2px solid red;
      padding: 4px;
    }

    @page { size: A4 portrait; margin: 10mm; }
    @media print {
      .grid { transform: scale(0.95); transform-origin: top left; }
      .table { font-size: 9px; }
      input, label { font-size: 9px; }
      .preisRabatt { font-size: 18px; }
    }
  </style>
</head>
<body>
  <button class="print-button" type="button" onclick="window.print()">üñ®Ô∏è Drucken</button>

  <div id="grid" class="grid"></div>

  <script>
    let ARTIKEL_INDEX = null;
    const TABLE_COUNT = 6;

    async function ladeArtikelListe() {
      if (ARTIKEL_INDEX) return ARTIKEL_INDEX;
      try {
        const response = await fetch('./artikel_liste.json', { cache: 'no-cache' });
        if (!response.ok) throw new Error('HTTP ' + response.status);
        ARTIKEL_INDEX = await response.json();
        return ARTIKEL_INDEX;
      } catch (e) {
        console.error('Fehler beim Laden artikel_liste.json:', e);
        ARTIKEL_INDEX = {};
        return ARTIKEL_INDEX;
      }
    }

    function createTableElement() {
      const wrap = document.createElement('div');
      wrap.className = 'table';
      wrap.innerHTML = `
        <label>Artikelnummer:</label>
        <div class="artikel-row">
          <input type="text" class="artikelnummer" autocomplete="off">
          <svg class="barcode"></svg>
        </div>

        <label>Bezeichnung:</label>
        <input type="text" class="bezeichnung" readonly>

        <label>St√§rke:</label>
        <input type="text" class="staerke" readonly>

        <label>L√§nge (mm):</label>
        <input type="number" class="laenge" inputmode="decimal" step="any">

        <label>Breite (mm):</label>
        <input type="number" class="breite" inputmode="decimal" step="any">

        <label>Fl√§che (m¬≤):</label>
        <input type="text" class="flaeche" readonly>

        <label>Preis:</label>
        <input type="text" class="preis" readonly>

        <label>Neuer Preis (mit 50% Nachlass):</label>
        <input type="text" class="preisRabatt" readonly>
      `;
      return wrap;
    }

    function updateBarcode(svgEl, value) {
      if (!value) { svgEl.innerHTML = ''; return; }
      try {
        JsBarcode(svgEl, value, { format: 'CODE128', displayValue: false, margin: 0, height: 40 });
      } catch (e) {
        console.error('Barcode Fehler:', e);
      }
    }

    async function berechne(table) {
      const artikelnummer = String(table.querySelector('.artikelnummer').value || '').trim();
      const laenge = parseFloat(table.querySelector('.laenge').value) || 0;
      const breite = parseFloat(table.querySelector('.breite').value) || 0;
      const flaeche = (laenge * breite) / 1_000_000;
      table.querySelector('.flaeche').value = flaeche > 0 ? flaeche.toFixed(3) : '0.000';

      const index = await ladeArtikelListe();
      const artikel = artikelnummer ? index[artikelnummer] : null;

      const bezFeld = table.querySelector('.bezeichnung');
      const staerkeFeld = table.querySelector('.staerke');
      const preisFeld = table.querySelector('.preis');
      const rabattFeld = table.querySelector('.preisRabatt');

      if (artikel) {
        bezFeld.value = artikel.bezeichnung || '';
        staerkeFeld.value = artikel.staerke || '';
        const preisProM2 = Number(artikel.preis) || 0;
        if (flaeche > 0 && preisProM2 > 0) {
          const preis = preisProM2 * flaeche;
          preisFeld.value = preis.toFixed(2) + ' ‚Ç¨';
          rabattFeld.value = (preis * 0.5).toFixed(2) + ' ‚Ç¨';
        } else {
          preisFeld.value = preisProM2 > 0 ? preisProM2.toFixed(2) + ' ‚Ç¨/m¬≤' : '';
          rabattFeld.value = preisProM2 > 0 ? (preisProM2 * 0.5).toFixed(2) + ' ‚Ç¨/m¬≤' : '';
        }
      } else {
        bezFeld.value = '';
        staerkeFeld.value = '';
        preisFeld.value = artikelnummer ? 'Artikel nicht gefunden' : '';
        rabattFeld.value = '';
      }

      updateBarcode(table.querySelector('.barcode'), artikelnummer);
    }

    function bindTableEvents(table) {
      const inputs = table.querySelectorAll('input');
      inputs.forEach(inp => {
        inp.addEventListener('input', () => berechne(table));
        inp.addEventListener('change', () => berechne(table));
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const grid = document.getElementById('grid');
      for (let i = 0; i < TABLE_COUNT; i++) {
        const t = createTableElement();
        grid.appendChild(t);
        bindTableEvents(t);
      }
      await ladeArtikelListe();
    });
  </script>
</body>
</html>
